<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diabetes Distress Screening Scale (DDS-17) – Calculator</title>
  <meta name="description" content="Client‑side DDS‑17 questionnaire and scorer for GitHub Pages. No data leaves your browser." />
  <style>
    :root{
      --fg:#0f172a;/* slate-900 */
      --muted:#475569;/* slate-600 */
      --bg:#f8fafc;/* slate-50 */
      --card:#ffffff;
      --brand:#2563eb;/* blue-600 */
      --warn:#f59e0b;/* amber-500 */
      --danger:#ef4444;/* red-500 */
      --ring: 0 0 0 3px rgba(37,99,235,.15);
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";color:var(--fg);background:var(--bg)}
    header{position:sticky;top:0;background:linear-gradient(to bottom, rgba(248,250,252,.9), rgba(248,250,252,.75));backdrop-filter:saturate(150%) blur(6px);z-index:10;border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1000px;margin-inline:auto;padding:1rem}
    .title{display:flex;gap:.8rem;align-items:center;flex-wrap:wrap}
    .pill{font-size:.8rem;padding:.25rem .5rem;border-radius:999px;background:#e2e8f0;color:#0f172a}
    main{padding:1rem}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:1rem;box-shadow:0 10px 25px rgba(2,6,23,.05);padding:1rem;margin:1rem 0}
    .controls{display:flex;flex-wrap:wrap;gap:.5rem}
    .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;color:var(--fg);padding:.6rem .9rem;border-radius:.75rem;cursor:pointer;font-weight:600}
    .btn:hover{box-shadow:var(--ring)}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    fieldset{border:none;margin:0;padding:0}
    .q{display:grid;grid-template-columns: 1fr auto;gap:.75rem;padding:1rem;border-radius:.75rem;border:1px solid #e5e7eb;margin:.75rem 0;background:#fff}
    .q h3{margin:.15rem 0;font-size:1rem}
    .scale{display:grid;grid-auto-flow:column;gap:.4rem;align-items:center}
    .scale label{display:grid;place-items:center;font-size:.9rem;color:var(--muted)}
    .scale input{accent-color:var(--brand)}
    .legend{display:grid;grid-template-columns:repeat(6,1fr);gap:.25rem;margin:.25rem 0 0 0;font-size:.75rem;color:var(--muted)}
    .results{display:grid;gap:.75rem}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;border-radius:.75rem;border:1px solid #e5e7eb;background:#fff}
    .stat .score{font-weight:800}
    .flag{font-size:.8rem;font-weight:700;padding:.25rem .5rem;border-radius:.5rem}
    .ok{background:rgba(16,185,129,.12);color:#065f46;border:1px solid rgba(16,185,129,.3)}
    .warn{background:rgba(245,158,11,.12);color:#92400e;border:1px solid rgba(245,158,11,.3)}
    .danger{background:rgba(239,68,68,.12);color:#7f1d1d;border:1px solid rgba(239,68,68,.3)}
    details{background:#fff;border:1px solid #e5e7eb;border-radius:.75rem;padding:.5rem 1rem}
    details summary{cursor:pointer;font-weight:600}
    footer{color:var(--muted);padding:2rem 1rem}
    .grid{display:grid;gap:1rem}
    @media (min-width:900px){
      .grid{grid-template-columns:1fr 320px}
    }
    .subtle{color:var(--muted)}
    .req{color:var(--danger);font-weight:700}

    /* PRINT-FRIENDLY LAYOUT for on-screen cards */
    @media print {
      @page { size: auto; margin: 12mm; }
      body{ background:#fff; }
      header, aside, .controls, details, footer{ display:none !important; }
      .wrap{ max-width:none; padding:0; }
      main{ padding:0; }
      .card{ box-shadow:none; border:0; margin:0; padding:0; }
      .q, .stat{ break-inside: avoid; page-break-inside: avoid; }
      .q{ border:1px solid #ccc; margin:.4rem 0; padding:.6rem; }
      .legend{ color:#111; }
      .grid{ grid-template-columns:1fr !important; }
    }

    /* PRINT-ONE-PAGE REPORT */
    #printReport{display:none}
    @media print {
      @page { size: Letter; margin: 8mm; }
      html, body{ background:#fff; }
      header, main, footer{ display:none !important; }
      #printReport{ display:block !important; padding:0; margin:0; }
      #printReport{ font: 9.5pt/1.25 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; color:#000; }
      #printReport h1{ font-size:12pt; margin:0 0 4pt 0; }
      #printReport .small{ font-size:9pt; color:#000; }
      #printReport pre{ white-space:pre-wrap; word-wrap:break-word; margin:0 }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <h1 style="margin:0">Diabetes Distress Screening Scale (DDS‑17)</h1>
      <span class="pill">client‑side • no tracking</span>
    </div>
  </header>

  <main class="wrap grid">
    <section>
      <div class="card">
        <p class="subtle" id="intro">
          Rate how much each item has distressed or bothered you <strong>during the past month</strong>.
          1 = Not a problem … 6 = A very serious problem.
        </p>
        <form id="form" novalidate>
          <!-- Questions render here -->
        </form>
        <div class="controls" style="margin-top:.5rem">
          <button class="btn primary" id="calcBtn" type="button">Calculate scores</button>
          <button class="btn" id="resetBtn" type="button">Reset</button>
          <button class="btn ghost" id="printBtn" type="button">Print / Save PDF</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin-top:0">Results</h2>
        <div id="results" class="results">
          <div class="subtle">Complete all 17 items, then click <em>Calculate scores</em>.</div>
        </div>
        <details style="margin-top:.75rem"><summary>Scoring notes</summary>
          <p>Mean item score ≥ <strong>3.0</strong> indicates at least <em>moderate</em> distress and is considered worthy of clinical attention. Subscales:</p>
          <ul>
            <li><strong>Emotional Burden (EB):</strong> items 1, 3, 8, 11, 14 (÷ 5)</li>
            <li><strong>Physician‑related Distress (PD):</strong> items 2, 4, 9, 15 (÷ 4)</li>
            <li><strong>Regimen‑related Distress (RD):</strong> items 5, 6, 10, 12, 16 (÷ 5)</li>
            <li><strong>Interpersonal Distress (ID):</strong> items 7, 13, 17 (÷ 3)</li>
          </ul>
          <p class="subtle">Attribution: DDS‑17 content © original authors; reproduced here for non‑commercial, clinical/educational use. See source PDF for full details.</p>
        </details>
      </div>
    </section>

    <aside>
      <div class="card">
        <h3 style="margin-top:0">About</h3>
        <p class="subtle">This open‑source page implements the DDS‑17 questionnaire and scoring client‑side so you can host it on GitHub Pages. Your entries are not sent anywhere.</p>
        <ul class="subtle">
          <li><strong>Keyboard:</strong> Use 1–6 to select a score when a question is focused.</li>
          <li><strong>Dev:</strong> A self‑test harness is included (hidden) to catch regressions.</li>
        </ul>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Export</h3>
        <p class="subtle">Use <em>Print / Save PDF</em> to create a record of responses and scores.</p>
      </div>
      <div class="card" id="dev-tests" style="display:none">
        <h3 style="margin-top:0">Developer self‑tests</h3>
        <button class="btn" id="runTests" type="button">Run self‑tests</button>
        <pre id="testOutput" class="subtle" style="white-space:pre-wrap"></pre>
      </div>
    </aside>
  </main>

  <!-- Plain-text print-only report -->
  <section id="printReport" aria-hidden="true">
    <h1>DDS‑17 Results & Answers</h1>
    <div id="printMeta" class="small"></div>
    <pre id="printBody"></pre>
  </section>

  <footer class="wrap subtle">
    <div>Built for GitHub Pages • No frameworks • MIT License (code only). DDS‑17 © respective copyright holders.</div>
  </footer>

  <script>
  // DDS-17 items and subscale mapping per the scoring sheet.
  const ITEMS = [
    {n:1,  text:"Feeling that diabetes is taking up too much of my mental and physical energy every day.", sub:"EB"},
    {n:2,  text:"Feeling that my doctor doesn't know enough about diabetes and diabetes care.", sub:"PD"},
    {n:3,  text:"Feeling angry, scared, and/or depressed when I think about living with diabetes.", sub:"EB"},
    {n:4,  text:"Feeling that my doctor doesn't give me clear enough directions on how to manage my diabetes.", sub:"PD"},
    {n:5,  text:"Feeling that I am not testing my blood sugars frequently enough.", sub:"RD"},
    {n:6,  text:"Feeling that I am often failing with my diabetes routine.", sub:"RD"},
    {n:7,  text:"Feeling that friends or family are not supportive enough of self-care efforts (e.g., planning activities that conflict with my schedule, encouraging me to eat the 'wrong' foods).", sub:"ID"},
    {n:8,  text:"Feeling that diabetes controls my life.", sub:"EB"},
    {n:9,  text:"Feeling that my doctor doesn't take my concerns seriously enough.", sub:"PD"},
    {n:10, text:"Not feeling confident in my day-to-day ability to manage diabetes.", sub:"RD"},
    {n:11, text:"Feeling that I will end up with serious long-term complications, no matter what I do.", sub:"EB"},
    {n:12, text:"Feeling that I am not sticking closely enough to a good meal plan.", sub:"RD"},
    {n:13, text:"Feeling that friends or family don't appreciate how difficult living with diabetes can be.", sub:"ID"},
    {n:14, text:"Feeling overwhelmed by the demands of living with diabetes.", sub:"EB"},
    {n:15, text:"Feeling that I don't have a doctor who I can see regularly enough about my diabetes.", sub:"PD"},
    {n:16, text:"Not feeling motivated to keep up my diabetes self management.", sub:"RD"},
    {n:17, text:"Feeling that friends or family don't give me the emotional support that I would like.", sub:"ID"},
  ];
  const SUB_DIV = {EB:5, PD:4, RD:5, ID:3};

  const form = document.getElementById('form');
  const results = document.getElementById('results');
  const printMeta = document.getElementById('printMeta');
  const printBody = document.getElementById('printBody');
  const runTestsBtn = document.getElementById('runTests');
  const testOutput = document.getElementById('testOutput');

  function renderQuestions(){
    const fs = document.createDocumentFragment();
    ITEMS.forEach(item => {
      const wrap = document.createElement('fieldset');
      wrap.className = 'q';
      wrap.innerHTML = `
        <div>
          <h3><span class="subtle">${item.n}.</span> ${item.text}</h3>
          <div class="legend" aria-hidden="true">
            <div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div>
          </div>
        </div>
        <div class="scale" role="radiogroup" aria-label="Question ${item.n}">
          ${[1,2,3,4,5,6].map(v=>`
            <label>
              <input type="radio" name="q${item.n}" value="${v}" required>
              <div>${v}</div>
            </label>
          `).join('')}
        </div>`;

      // Keyboard shortcuts 1..6 when focused
      wrap.addEventListener('keydown', (e)=>{
        const k = parseInt(e.key,10);
        if(k>=1 && k<=6){
          const input = wrap.querySelector(`input[value="${k}"]`);
          if(input){ input.checked = true; e.preventDefault(); }
        }
      });
      fs.appendChild(wrap);
    });
    form.appendChild(fs);
  }

  function getValues(){
    const vals = {};
    let complete = true;
    ITEMS.forEach(i=>{
      const sel = form.querySelector(`input[name="q${i.n}"]:checked`);
      if(!sel){ complete = false; }
      vals[i.n] = sel ? Number(sel.value) : null;
    });
    return {vals, complete};
  }

  function mean(arr){
    const s = arr.reduce((a,b)=>a+b,0);
    return s/arr.length;
  }

  function badge(score){
    const span = document.createElement('span');
    span.className = 'flag ' + (score >= 3.0 ? (score >= 4.0 ? 'danger' : 'warn') : 'ok');
    span.textContent = (score >= 3.0 ? (score >= 4.0 ? '≥4 High' : '≥3 Moderate') : '<3 Low');
    return span;
  }

  function calc(){
    const {vals, complete} = getValues();
    if(!complete){
      results.innerHTML = '<div><span class="req">Incomplete.</span> Please answer all 17 items.</div>';
      return;
    }
    const all = ITEMS.map(i=>vals[i.n]);
    const totalMean = Number(mean(all).toFixed(2));

    // Subscales
    const bySub = {EB:[], PD:[], RD:[], ID:[]};
    ITEMS.forEach(i => bySub[i.sub].push(vals[i.n]));
    const subMeans = Object.fromEntries(Object.entries(bySub).map(([k,arr])=>[k, Number(mean(arr).toFixed(2))]));

    // Render
    const frag = document.createDocumentFragment();

    const mk = (label, score) => {
      const row = document.createElement('div');
      row.className = 'stat';
      row.innerHTML = `<div>${label}</div><div class="score">${score.toFixed(2)}</div>`;
      row.appendChild(badge(score));
      return row;
    };

    frag.appendChild(mk('Total DDS mean (17 items ÷ 17)', totalMean));
    frag.appendChild(mk(`Emotional Burden (items 1,3,8,11,14 ÷ ${SUB_DIV.EB})`, subMeans.EB));
    frag.appendChild(mk(`Physician-related Distress (items 2,4,9,15 ÷ ${SUB_DIV.PD})`, subMeans.PD));
    frag.appendChild(mk(`Regimen-related Distress (items 5,6,10,12,16 ÷ ${SUB_DIV.RD})`, subMeans.RD));
    frag.appendChild(mk(`Interpersonal Distress (items 7,13,17 ÷ ${SUB_DIV.ID})`, subMeans.ID));

    const flagged = ITEMS.filter(i => vals[i.n] >= 3).map(i=>`${i.n}`);
    const note = document.createElement('div');
    note.className = 'subtle';
    note.style.marginTop = '.5rem';
    note.textContent = flagged.length ? `Items ≥3: ${flagged.join(', ')}.` : 'No items ≥3.';
    frag.appendChild(note);

    results.replaceChildren(frag);
  }

  function resetAll(){
    form.reset();
    results.innerHTML = '<div class="subtle">Complete all 17 items, then click <em>Calculate scores</em>.</div>';
  }

  // Helpers to compute and print a compact, single-page report
  function computeMetrics(){
    const {vals, complete} = getValues();
    const answered = ITEMS.filter(i=> vals[i.n] != null);
    const all = ITEMS.map(i=> vals[i.n] ?? 0);
    const totalMean = answered.length === ITEMS.length ? Number(mean(all).toFixed(2)) : NaN;
    const bySub = {EB:[], PD:[], RD:[], ID:[]};
    ITEMS.forEach(i => { if(vals[i.n] != null) bySub[i.sub].push(vals[i.n]); });
    const subMeans = Object.fromEntries(Object.entries(bySub).map(([k,arr])=>[
      k, arr.length ? Number(mean(arr).toFixed(2)) : NaN
    ]));
    return {vals, complete, totalMean, subMeans};
  }

  function generatePrint(){
    const {vals, complete, totalMean, subMeans} = computeMetrics();
    const now = new Date();
    const dt = now.toLocaleString();
    printMeta.textContent = `Generated: ${dt}  •  Scale 1–6 (1=Not a problem, 6=A very serious problem)`;

    const lines = [];
    if(!Number.isNaN(totalMean)){
      const flag = totalMean >= 4 ? 'HIGH' : (totalMean >= 3 ? 'MOD' : 'LOW');
      lines.push(`TOTAL MEAN: ${totalMean.toFixed(2)}  [${flag}]`);
    } else {
      lines.push('TOTAL MEAN: —   (incomplete)');
    }
    const fmt = (v)=> Number.isNaN(v) ? '—' : v.toFixed(2);
    lines.push(`EB: ${fmt(subMeans.EB)}   PD: ${fmt(subMeans.PD)}   RD: ${fmt(subMeans.RD)}   ID: ${fmt(subMeans.ID)}`);
    lines.push('');
    lines.push('ANSWERS (Q#: score):');

    const row = [];
    ITEMS.forEach(i=>{ row.push(`${i.n}:${vals[i.n] ?? '—'}`); });
    let buf = '';
    row.forEach((cell,idx)=>{
      const s = (idx? '  ' : '') + cell;
      if((buf + s).length > 80){ lines.push(buf); buf = cell; }
      else { buf += s; }
    });
    if(buf) lines.push(buf);

    // FIX: use proper newline escape, not a raw line break
    printBody.textContent = lines.join('\n');
  }

  // --- Developer self-tests (run manually) ---
  function setAllAnswers(val){
    ITEMS.forEach(i=>{
      const input = form.querySelector(`input[name="q${i.n}"][value="${val}"]`);
      if(input) input.checked = true;
    });
  }
  function clearAllAnswers(){ form.reset(); }

  function approxEqual(a,b,eps=1e-6){ return Math.abs(a-b) <= eps; }

  function runSelfTests(){
    const out = [];

    // Test 1: all 1s
    clearAllAnswers(); setAllAnswers(1);
    let m = computeMetrics();
    out.push(`#1 all 1s → total mean should be 1.00`);
    out.push(` actual: ${m.totalMean}`);
    if(!(approxEqual(m.totalMean,1))) out.push('  FAIL'); else out.push('  PASS');

    // Test 2: all 3s
    clearAllAnswers(); setAllAnswers(3);
    m = computeMetrics();
    out.push(`#2 all 3s → total mean should be 3.00; subs 3.00`);
    out.push(` actual: total=${m.totalMean} EB=${m.subMeans.EB} PD=${m.subMeans.PD} RD=${m.subMeans.RD} ID=${m.subMeans.ID}`);
    const pass2 = approxEqual(m.totalMean,3) && approxEqual(m.subMeans.EB,3) && approxEqual(m.subMeans.PD,3) && approxEqual(m.subMeans.RD,3) && approxEqual(m.subMeans.ID,3);
    out.push(pass2 ? '  PASS' : '  FAIL');

    // Test 3: incomplete (first 5 answered with 6)
    clearAllAnswers();
    for(let i=1;i<=5;i++){
      const input = form.querySelector(`input[name="q${i}"][value="6"]`);
      if(input) input.checked = true;
    }
    m = computeMetrics();
    out.push(`#3 incomplete → total mean should be NaN, generatePrint should not throw`);
    out.push(` actual totalMean isNaN: ${Number.isNaN(m.totalMean)}`);
    const before = printBody.textContent;
    try{ generatePrint(); out.push('  generatePrint: PASS'); }
    catch(e){ out.push('  generatePrint: FAIL ' + e.message); }

    // Restore: clear form
    clearAllAnswers();

    testOutput.textContent = out.join('\n');
  }

  // Wire up UI
  document.getElementById('calcBtn').addEventListener('click', calc);
  document.getElementById('resetBtn').addEventListener('click', resetAll);
  document.getElementById('printBtn').addEventListener('click', ()=>{ calc(); generatePrint(); window.print(); });
  window.addEventListener('beforeprint', ()=>{ calc(); generatePrint(); });
  if(runTestsBtn){ runTestsBtn.addEventListener('click', runSelfTests); }

  // Initial render
  renderQuestions();
  </script>
</body>
</html>
